# Regras do Agente Cursor - Sharezin

## üìã Vis√£o Geral do Projeto

Sharezin √© uma aplica√ß√£o web Next.js 16 para gerenciar recibos compartilhados e calcular divis√µes de contas automaticamente. O projeto usa TypeScript, Tailwind CSS, Supabase (PostgreSQL) e segue uma arquitetura em camadas bem definida.

---

## üèóÔ∏è Arquitetura e Estrutura

### Organiza√ß√£o de Pastas

- `app/` - Rotas Next.js (App Router) e API Routes
- `components/` - Componentes React reutiliz√°veis
- `contexts/` - Contextos React (Auth, Theme, Receipts, Notifications, UserPlan)
- `hooks/` - Custom Hooks para l√≥gica reutiliz√°vel
- `lib/` - Utilit√°rios, servi√ßos e fun√ß√µes auxiliares
  - `services/` - Servi√ßos de neg√≥cio (authService, receiptService, etc.)
  - `transformers/` - Transformadores de dados (snake_case ‚Üî camelCase)
- `types/` - Defini√ß√µes TypeScript

### Fluxo de Dados

```
Componente ‚Üí Hook ‚Üí API Route ‚Üí Service ‚Üí Supabase ‚Üí Database
                ‚Üì
         Transforma√ß√£o (snake_case ‚Üî camelCase)
                ‚Üì
         Retorno ao componente
```

**IMPORTANTE**: Sempre seguir este fluxo. N√£o pular camadas.

---

## üî§ Conven√ß√µes de Nomenclatura

### Arquivos e Pastas
- **Componentes**: PascalCase (`ReceiptCard.tsx`, `ProductForm.tsx`)
- **Hooks**: camelCase com prefixo `use` (`useReceipts.ts`, `useAuth.ts`)
- **Servi√ßos**: camelCase com sufixo `Service` (`receiptService.ts`, `authService.ts`)
- **Utilit√°rios**: camelCase (`calculations.ts`, `utils.ts`)
- **API Routes**: `route.ts` dentro de pastas nomeadas (`app/api/receipts/route.ts`)
- **Tipos**: PascalCase (`Receipt`, `Participant`, `ReceiptItem`)

### Vari√°veis e Fun√ß√µes
- **Vari√°veis**: camelCase (`receiptId`, `participantName`)
- **Fun√ß√µes**: camelCase (`calculateTotal`, `formatCurrency`)
- **Constantes**: UPPER_SNAKE_CASE (`MAX_PARTICIPANTS`, `DEFAULT_SERVICE_CHARGE`)
- **Interfaces/Types**: PascalCase (`User`, `ApiReceipt`)

### Banco de Dados
- **Tabelas**: snake_case (`receipts`, `receipt_items`, `receipt_participants`)
- **Colunas**: snake_case (`creator_id`, `service_charge_percent`, `is_closed`)
- **Campos retornados da API**: snake_case (transformar para camelCase no frontend)

---

## üîÑ Transforma√ß√£o de Dados

### Regra Cr√≠tica: snake_case ‚Üî camelCase

**API retorna**: `snake_case` (ex: `creator_id`, `service_charge_percent`, `is_closed`)
**Frontend usa**: `camelCase` (ex: `creatorId`, `serviceChargePercent`, `isClosed`)

### Como Transformar

1. **Ao receber dados da API**:
   - Usar `transformToCamelCase<T>()` de `@/lib/api`
   - Ou usar transformers espec√≠ficos como `transformReceiptFromApi()` de `@/lib/transformers/receiptTransformer`

2. **Ao enviar dados para API**:
   - Usar `transformToSnakeCase<T>()` de `@/lib/api`
   - Ou transformar manualmente campos espec√≠ficos

3. **Exemplo**:
```typescript
// ‚úÖ CORRETO - Recebendo da API
const apiReceipt = await apiRequest<ApiReceipt>('/api/receipts/123');
const receipt = transformReceiptFromApi(apiReceipt); // Transforma para camelCase

// ‚úÖ CORRETO - Enviando para API
const receiptToSend = transformToSnakeCase(receipt);
await apiRequest('/api/receipts/123', {
  method: 'PUT',
  body: JSON.stringify(receiptToSend)
});
```

**NUNCA** misturar snake_case e camelCase no mesmo objeto.

---

## üõ°Ô∏è Autentica√ß√£o e Seguran√ßa

### Padr√µes de Autentica√ß√£o

1. **API Routes**:
   - Sempre verificar autentica√ß√£o usando `getAuthUser(request)` de `@/lib/auth`
   - Retornar `createAuthResponse('N√£o autenticado')` se n√£o autenticado
   - Exemplo:
```typescript
export async function GET(request: NextRequest) {
  const user = await getAuthUser(request);
  if (!user) {
    return createAuthResponse('N√£o autenticado');
  }
  // ... resto do c√≥digo
}
```

2. **Cliente Supabase**:
   - **No servidor**: Sempre usar `createServerClient()` de `@/lib/supabase` (usa Service Role Key)
   - **No cliente**: Usar `supabase` de `@/lib/supabase` (usa Anon Key)
   - **NUNCA** usar Service Role Key no cliente

3. **Tokens JWT**:
   - Armazenar em `localStorage` como `auth_token`
   - Incluir no header: `Authorization: Bearer ${token}`
   - Usar `apiRequest()` que j√° adiciona o token automaticamente

### Prote√ß√£o de Rotas

- Usar `RouteGuard` para proteger rotas no frontend
- Verificar autentica√ß√£o em todas as API routes

---

## üì° API Routes

### Estrutura Padr√£o

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getAuthUser, createAuthResponse } from '@/lib/auth';
import { createServerClient } from '@/lib/supabase';

export async function GET(request: NextRequest) {
  // 1. Autentica√ß√£o
  const user = await getAuthUser(request);
  if (!user) {
    return createAuthResponse('N√£o autenticado');
  }

  try {
    // 2. Obter par√¢metros
    const searchParams = request.nextUrl.searchParams;
    const param = searchParams.get('param');

    // 3. Criar cliente Supabase
    const supabase = createServerClient();

    // 4. Buscar dados
    const { data, error } = await supabase.from('table').select('*');

    // 5. Tratar erros
    if (error) {
      return NextResponse.json(
        { error: 'Internal Server Error', message: 'Erro ao buscar dados' },
        { status: 500 }
      );
    }

    // 6. Transformar dados (snake_case ‚Üí camelCase se necess√°rio)
    // 7. Retornar resposta
    return NextResponse.json({ data });
  } catch (error) {
    return NextResponse.json(
      { error: 'Internal Server Error', message: 'Erro ao processar requisi√ß√£o' },
      { status: 500 }
    );
  }
}
```

### C√≥digos de Status HTTP

- `200` - Sucesso (GET, PUT)
- `201` - Criado (POST)
- `400` - Bad Request (valida√ß√£o)
- `401` - N√£o autenticado
- `403` - Proibido (limite de plano, permiss√£o)
- `404` - N√£o encontrado
- `500` - Erro interno do servidor
- `503` - Servi√ßo indispon√≠vel (ex: cache do Supabase)

### Respostas de Erro

Sempre retornar no formato:
```typescript
{
  error: 'Error Type',
  message: 'Mensagem amig√°vel para o usu√°rio'
}
```

---

## ‚öõÔ∏è Componentes React

### Componentes Client-Side

- Marcar com `'use client'` no topo do arquivo
- Usar hooks do Next.js: `useRouter`, `usePathname`, etc.

### Componentes Server-Side

- N√£o usar `'use client'`
- N√£o usar hooks ou estado
- Apenas para renderiza√ß√£o est√°tica

### Padr√µes de Componentes

1. **Props**: Usar interfaces TypeScript
2. **Estado**: Usar `useState` ou hooks customizados
3. **Efeitos**: Usar `useEffect` com depend√™ncias corretas
4. **Callbacks**: Usar `useCallback` para fun√ß√µes passadas como props

### Exemplo de Componente

```typescript
'use client';

import { useState } from 'react';
import { Receipt } from '@/types';

interface ReceiptCardProps {
  receipt: Receipt;
  onSelect?: (receipt: Receipt) => void;
}

export function ReceiptCard({ receipt, onSelect }: ReceiptCardProps) {
  const [loading, setLoading] = useState(false);

  // ... l√≥gica do componente
}
```

---

## üé£ Custom Hooks

### Padr√£o de Hooks

1. **Nome**: Come√ßar com `use` (ex: `useReceipts`, `useAuth`)
2. **Retorno**: Objeto com estado e fun√ß√µes
3. **Estado interno**: Gerenciar com `useState`
4. **Efeitos**: Usar `useEffect` para carregamento inicial se necess√°rio

### Exemplo de Hook

```typescript
export function useReceipts() {
  const [receipts, setReceipts] = useState<Receipt[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const loadReceipts = useCallback(async () => {
    // ... l√≥gica
  }, []);

  return {
    receipts,
    loading,
    error,
    loadReceipts,
  };
}
```

---

## üîß Servi√ßos (Services)

### Padr√£o de Servi√ßos

1. **Localiza√ß√£o**: `lib/services/`
2. **Nome**: `[entidade]Service.ts` (ex: `receiptService.ts`)
3. **Fun√ß√µes**: Exportar fun√ß√µes puras que recebem `SupabaseClient` como par√¢metro
4. **Sem estado**: Servi√ßos n√£o devem ter estado interno

### Exemplo de Servi√ßo

```typescript
import { SupabaseClient } from '@supabase/supabase-js';
import { Receipt } from '@/types';

export async function fetchReceiptData(
  supabase: SupabaseClient,
  receiptId: string
): Promise<ReceiptData> {
  // ... l√≥gica usando supabase
  return data;
}
```

---

## üé® Estiliza√ß√£o (Tailwind CSS)

### Classes Tailwind

- Usar classes utilit√°rias do Tailwind
- Classes customizadas definidas em `globals.css`
- Cores: Usar tokens do tema (`bg-primary`, `text-text-primary`, etc.)

### Tema

- Suporte a dark mode via `ThemeContext`
- Usar classes condicionais para dark mode quando necess√°rio

### Responsividade

- Mobile-first: Come√ßar com classes mobile, depois adicionar breakpoints
- Breakpoints: `sm:`, `md:`, `lg:`, `xl:`

---

## üìä C√°lculos e Formata√ß√£o

### Fun√ß√µes de C√°lculo

- Localiza√ß√£o: `lib/calculations.ts`
- Sempre arredondar para 2 casas decimais usando `roundToTwoDecimals()`
- Formatar moeda usando `formatCurrency()` (formato pt-BR)

### Regras de C√°lculo

1. **Total do item**: `quantity * price`
2. **Taxa de servi√ßo**: Proporcional ao consumo de cada participante
3. **Cover**: Dividido igualmente entre todos os participantes
4. **Total do recibo**: `itemsTotal + serviceChargeAmount + cover`

---

## üîî Notifica√ß√µes

### Tipos de Notifica√ß√£o

Definidos em `types/index.ts`:
- `participant_request`
- `participant_approved`
- `participant_rejected`
- `deletion_request`
- `deletion_approved`
- `deletion_rejected`
- `receipt_closed`
- `item_added`
- `creator_transferred`
- `creator_transferred_from`

### Criar Notifica√ß√µes

- Usar `notificationService` para criar notifica√ß√µes
- Sempre incluir `userId`, `type`, `title`, `message`
- Opcionalmente incluir `receiptId` e `relatedUserId`

---

## üí≥ Sistema de Planos

### Verifica√ß√£o de Limites

- Sempre verificar limites do plano antes de opera√ß√µes:
  - `canCreateReceipt()` - Verificar limite de recibos por m√™s
  - `getUserPlanLimits()` - Obter limites do plano do usu√°rio
  - Verificar `maxParticipantsPerReceipt` ao adicionar participantes
  - Verificar `maxHistoryReceipts` ao listar recibos fechados

### Retornar Erros de Limite

```typescript
if (!canCreate.allowed) {
  return NextResponse.json(
    { error: 'Plan Limit', message: canCreate.reason || 'Limite atingido' },
    { status: 403 }
  );
}
```

---

## üö® Tratamento de Erros

### API Routes

```typescript
try {
  // ... c√≥digo
} catch (error) {
  return NextResponse.json(
    { error: 'Internal Server Error', message: 'Erro ao processar requisi√ß√£o' },
    { status: 500 }
  );
}
```

### Frontend (Hooks/Components)

```typescript
try {
  // ... c√≥digo
} catch (err) {
  const errorMessage = err instanceof Error ? err.message : 'Erro desconhecido';
  setError(errorMessage);
  // Tratar erro de autentica√ß√£o
  if (errorMessage.includes('401') || errorMessage.includes('N√£o autenticado')) {
    // Limpar estado ou redirecionar
  }
}
```

### Valida√ß√£o

- Sempre validar dados de entrada nas API routes
- Retornar `400 Bad Request` com mensagem clara para valida√ß√µes

---

## üìù TypeScript

### Tipos e Interfaces

- Sempre definir tipos para props de componentes
- Usar interfaces para objetos complexos
- Usar types para unions e intersections
- Tipos principais em `types/index.ts`

### Tipagem Estrita

- Sempre tipar retornos de fun√ß√µes
- Usar `as` apenas quando necess√°rio e com cuidado
- Preferir type guards ao inv√©s de `as`

### Exemplo

```typescript
interface Receipt {
  id: string;
  title: string;
  // ... outros campos
}

function getReceipt(id: string): Promise<Receipt | null> {
  // ...
}
```

---

## üîç Busca e Filtros

### Buscar Recibos

- `includeClosed=true`: Retornar todos (abertos + fechados)
- `onlyClosed=true`: Retornar apenas fechados (hist√≥rico)
- Sem par√¢metros: Retornar apenas abertos

### Pagina√ß√£o

- Usar `limit` e `offset` para pagina√ß√£o
- Padr√£o: `limit=25`, `offset` calculado a partir da p√°gina

---

## üéØ Boas Pr√°ticas Gerais

1. **Imports**: Organizar por tipo (React, Next.js, libs, componentes, tipos)
2. **Coment√°rios**: Documentar fun√ß√µes complexas e l√≥gica de neg√≥cio
3. **Performance**: Usar `useCallback` e `useMemo` quando apropriado
4. **Loading States**: Sempre mostrar estados de carregamento
5. **Error States**: Tratar e exibir erros de forma amig√°vel
6. **Valida√ß√£o**: Validar dados tanto no frontend quanto no backend
7. **Seguran√ßa**: Nunca expor Service Role Key no cliente
8. **Transforma√ß√£o**: Sempre transformar dados entre API e frontend
9. **Consist√™ncia**: Seguir padr√µes existentes no c√≥digo
10. **Testes**: Considerar casos extremos e erros

---

## ‚ö†Ô∏è Erros Comuns a Evitar

1. ‚ùå Misturar `snake_case` e `camelCase` no mesmo objeto
2. ‚ùå Usar Service Role Key no cliente
3. ‚ùå Pular camadas da arquitetura (ex: componente chamando Supabase diretamente)
4. ‚ùå N√£o verificar autentica√ß√£o em API routes
5. ‚ùå N√£o validar dados de entrada
6. ‚ùå N√£o tratar erros adequadamente
7. ‚ùå N√£o verificar limites de plano
8. ‚ùå Criar componentes sem `'use client'` quando necess√°rio
9. ‚ùå N√£o usar transformers ao receber/enviar dados da API
10. ‚ùå Esquecer de atualizar estado ap√≥s opera√ß√µes ass√≠ncronas

---

## üìö Refer√™ncias R√°pidas

- **Autentica√ß√£o**: `@/lib/auth` - `getAuthUser()`, `createAuthResponse()`
- **API Requests**: `@/lib/api` - `apiRequest()`, `transformToCamelCase()`, `transformToSnakeCase()`
- **Supabase**: `@/lib/supabase` - `createServerClient()` (servidor), `supabase` (cliente)
- **C√°lculos**: `@/lib/calculations` - `calculateReceiptTotal()`, `formatCurrency()`
- **Transformers**: `@/lib/transformers/receiptTransformer` - `transformReceiptFromApi()`
- **Tipos**: `@/types` - `Receipt`, `Participant`, `ReceiptItem`, etc.
- **Hooks**: `@/hooks` - `useReceipts()`, `useAuth()`, etc.
- **Contextos**: `@/contexts` - `AuthContext`, `ReceiptsContext`, etc.

---

## üéì Ao Adicionar Novas Funcionalidades

1. Definir tipos em `types/index.ts`
2. Criar servi√ßos em `lib/services/` se necess√°rio
3. Criar hooks em `hooks/` para l√≥gica reutiliz√°vel
4. Criar componentes em `components/` se reutiliz√°vel
5. Criar API routes em `app/api/`
6. Seguir padr√µes de transforma√ß√£o de dados
7. Adicionar valida√ß√£o e tratamento de erros
8. Verificar limites de plano se aplic√°vel
9. Adicionar notifica√ß√µes se necess√°rio
10. Atualizar documenta√ß√£o se necess√°rio

---

**√öltima atualiza√ß√£o**: Baseado na an√°lise do projeto Sharezin
**Vers√£o**: 1.0
